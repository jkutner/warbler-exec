#!/usr/bin/env ruby

require 'zip/zip'
require 'tmpdir'

path_to_war = ARGV.shift 

destination = Dir.mktmpdir
Zip::ZipFile.open(path_to_war) do |zipfile|
  zipfile.each do |f|
    f_path = File.join(destination, f.name)
    FileUtils.mkdir_p(File.dirname(f_path))
    zipfile.extract(f, f_path)
  end
end

Dir.chdir(File.join(destination, "WEB-INF"))
ENV["CLASSPATH"] = Dir["#{Dir.pwd}/lib/*.jar"].join(File::PATH_SEPARATOR)
ENV["GEM_PATH"] = "#{Dir.pwd}/gems"
ENV["GEM_HOME"] = "#{Dir.pwd}/gems"

begin 
  Kernel.exec("java -Xmx512m -cp #{ENV["CLASSPATH"]} org.jruby.Main #{ARGV.join(" ")}")
rescue Errno::EACCES
  puts "warbler-exec: not executable: #{ARGV.first}"
  exit 126
rescue Errno::ENOENT
  puts "warbler-exec: command not found: #{ARGV.first}"
  exit 127
rescue ArgumentError
  puts "warbler-exec: exec needs a command to run"
  exit 128
end


